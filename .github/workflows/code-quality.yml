name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Analysis
    
    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch full history for better analysis
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff mypy bandit safety vulture radon
    
    - name: Run comprehensive linting
      run: |
        echo "=== Ruff Linting ==="
        ruff check src/ tests/ --output-format=github
        
        echo "=== Ruff Formatting Check ==="
        ruff format --check src/ tests/
    
    - name: Run type checking
      run: |
        echo "=== MyPy Type Checking ==="
        mypy src/ --ignore-missing-imports --show-error-codes
      continue-on-error: true  # Type checking is informational for now
    
    - name: Run security analysis
      run: |
        echo "=== Bandit Security Analysis ==="
        bandit -r src/ -f txt -ll
        
        echo "=== Safety Vulnerability Check ==="
        safety check --json || true
    
    - name: Check for dead code
      run: |
        echo "=== Vulture Dead Code Detection ==="
        vulture src/ --min-confidence 80
      continue-on-error: true  # Dead code detection is informational
    
    - name: Calculate code complexity
      run: |
        echo "=== Radon Complexity Analysis ==="
        radon cc src/ -a -nb
        radon mi src/ -nb
      continue-on-error: true  # Complexity analysis is informational
    
    - name: Generate code quality report
      run: |
        echo "# Code Quality Report" > code-quality-report.md
        echo "Generated on: $(date)" >> code-quality-report.md
        echo "" >> code-quality-report.md
        
        echo "## Linting Results" >> code-quality-report.md
        ruff check src/ tests/ --output-format=text >> code-quality-report.md || true
        
        echo "" >> code-quality-report.md
        echo "## Security Analysis" >> code-quality-report.md
        bandit -r src/ -f txt >> code-quality-report.md || true
        
        echo "" >> code-quality-report.md
        echo "## Complexity Metrics" >> code-quality-report.md
        radon cc src/ -a >> code-quality-report.md || true
    
    - name: Upload code quality report
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-report
        path: code-quality-report.md
        retention-days: 30

  test-coverage:
    runs-on: ubuntu-latest
    name: Test Coverage Analysis
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov coverage[toml]
    
    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=src --cov-report=html --cov-report=xml --cov-report=term-missing
    
    - name: Generate coverage badge
      run: |
        coverage-badge -o coverage-badge.svg
      continue-on-error: true
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
          coverage-badge.svg
        retention-days: 30
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 70