name: Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  AWS_REGION: eu-west-1

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to staging
      run: |
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh \
          --bot-token "${{ secrets.TELEGRAM_BOT_TOKEN_STAGING }}" \
          --chat-id "${{ secrets.TELEGRAM_CHAT_ID_STAGING }}" \
          --stack-name "rss-telegram-bot-staging" \
          --region "${{ env.AWS_REGION }}"
    
    - name: Run smoke tests
      run: |
        # Wait for deployment to be ready
        sleep 30
        # Test Lambda function
        aws lambda invoke \
          --function-name rss-telegram-bot-staging-function \
          --payload '{"test": true}' \
          response.json
        cat response.json

  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    needs: []
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to production
      run: |
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh \
          --bot-token "${{ secrets.TELEGRAM_BOT_TOKEN_PROD }}" \
          --chat-id "${{ secrets.TELEGRAM_CHAT_ID_PROD }}" \
          --stack-name "rss-telegram-bot-prod" \
          --region "${{ env.AWS_REGION }}"
    
    - name: Run production smoke tests
      run: |
        # Wait for deployment to be ready
        sleep 30
        # Test Lambda function
        aws lambda invoke \
          --function-name rss-telegram-bot-prod-function \
          --payload '{"test": true}' \
          response.json
        cat response.json
    
    - name: Create GitHub release
      uses: actions/create-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          Automated release for RSS Telegram Bot
          
          Changes in this release:
          - See commit history for detailed changes
          
          Deployment:
          - Deployed to production environment
          - All tests passed
        draft: false
        prerelease: false